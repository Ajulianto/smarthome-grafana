"use strict";function queryParams(a){if(!a)return{};var b,c=a.toString(),d=c.indexOf("?"),e=d!==-1?c.substring(d+1):"",f=/([^&=]+)=?([^&]*)/g,g=function(a){return decodeURIComponent(a.replace(/\+/g," "))},h={};do b=f.exec(e),b&&(h[g(b[1])]=g(b[2]));while(b);return h}function resolveParam(a,b){return void 0!==a&&void 0!==a[b]?a[b]:void 0!==urlParams&&void 0!==urlParams[b]?urlParams[b]:void 0!==parentUrlParams&&void 0!==parentUrlParams[b]?parentUrlParams[b]:SMARTHOME_GRAFANA_DEFAULTS[b]}function SmartHomeSubscriber(a){function b(a){var b=a,c="undefined"!=typeof b.type?b.type:"GET",d="undefined"!=typeof b.data?b.data:"",e="undefined"!=typeof b.headers?b.headers:{},f=new XMLHttpRequest;f.open(c,b.url,!0);for(var g in e)f.setRequestHeader(g,e[g]);return f.onload=function(){return f.status<200||f.status>400?void("function"==typeof b.error&&b.error(f)):void("function"==typeof b.callback&&b.callback(f))},f.onerror=function(){"function"==typeof b.error&&b.error(f)},f.send(d),f}function c(){var a=[];for(var b in n)void 0===n[b].value&&a.push(b);return a}function d(){return 0===c().length}function e(){if(!l&&d()){l=!0;for(var a=0;a<m.length;a++)m[a]()}}function f(a,b){if(n[a].value!==b){n[a].value=b;for(var c=n[a].listeners,d=0;d<c.length;d++){var f=c[d];f(a,b)}e()}}function g(a){var b=this;b.navigate=function(){},b.source=new EventSource(a),b.source.addEventListener("event",function(a){if(!b.paused){var c,d=JSON.parse(a.data),e=d.item.name;if(void 0!==n[e]){if("string"==typeof d.label&&d.label.indexOf("[")!==-1&&d.label.indexOf("]")!==-1){var g=d.label.indexOf("[");c=d.label.substr(g+1,d.label.lastIndexOf("]")-(g+1))}else c=d.item.state;f(e,c)}}})}function h(){var a=this;a.startSubscriber=function(b){var c,d,e;try{c=JSON.parse(b.responseText)}catch(f){return}if("CREATED"===c.status){try{d=c.context.headers.Location[0]}catch(f){return}e=d.split("/"),o.id=e[e.length-1],g.call(a,d+"?sitemap="+o.sitemap+"&pageid="+o.page)}},b({url:"/rest/sitemaps/events/subscribe",type:"POST",callback:a.startSubscriber})}function i(){var a=this;a.valueHandler=function(a){var b;try{b=JSON.parse(a.responseText)}catch(c){return}f(b.name,b.state)};for(var d=c(),g=0;g<d.length;g++)b({url:"/rest/items/"+d[g],type:"GET",callback:a.valueHandler});e()}function j(){void 0===o.page&&(o.page=o.sitemap),document.addEventListener("DOMContentLoaded",function(){o.valuesInitializer=new i,o.changeListener=new h})}var k=a,l=!1,m=[],n={},o={id:"",page:resolveParam(k,"w"),sitemap:resolveParam(k,"sitemap")};this.addItemListener=function(a,b){if("function"!=typeof b)throw new Error("addItemListener 'listener' is not a function");void 0!==n[a]?n[a].listeners.push(b):n[a]={listeners:[b],value:void 0}},this.addInitializedListener=function(a){if("function"!=typeof a)throw new Error("addInitializedListener 'listener' is not a function");m.push(a)},this.isInitialized=function(){return l},j()}function GrafanaPanel(a){function b(){var a=h;a+=i.dashboard.value;var b=!0;for(var c in i)void 0!==i[c].key&&(a+=(b?"?":"&")+i[c].key+"="+i[c].value,b=!1);var d=document.getElementById(g);"true"===f?(d.contentWindow.document.open(),d.contentWindow.document.write('<a href="'+a+'">'+a+"</a>"),d.contentWindow.document.close()):document.getElementById(g).src!==a&&d.contentWindow.location.replace(a)}function c(a,c){for(var d in i)void 0!==i[d].itemName&&i[d].itemName===a&&(i[d].itemFunction&&(c=i[d].itemFunction(c)),i[d].value=c);smartHomeSubscriber.isInitialized()&&b()}function d(){if(void 0===g)throw new Error("Property 'frame' is undefined");if(void 0===h)throw new Error("Property 'urlPrefix' is undefined");for(var a in i){var d=i[a].itemName;if(void 0!==d)smartHomeSubscriber.addItemListener(d,c);else if(void 0===i[a].value)throw new Error("URL variable '"+a+"' requires a default value or itemName to obtain the value from")}smartHomeSubscriber.addInitializedListener(b)}var e=a,f=resolveParam(e,"debug"),g=resolveParam(e,"frame"),h=resolveParam(e,"urlPrefix"),i={dashboard:{value:resolveParam(e,"dashboard"),itemName:resolveParam(e,"dashboardItem"),itemFunction:a.dashboardItemFunction},from:{key:"from",value:resolveParam(e,"from"),itemName:resolveParam(e,"fromItem"),itemFunction:a.fromItemFunction},to:{key:"to",value:resolveParam(e,"to"),itemName:resolveParam(e,"toItem"),itemFunction:a.toItemFunction},panel:{key:"panelId",value:resolveParam(e,"panel"),itemName:resolveParam(e,"panelItem"),itemFunction:a.panelItemFunction},theme:{key:"theme",value:resolveParam(e,"theme"),itemName:resolveParam(e,"themeItem"),itemFunction:a.themeItemFunction}};d()}function addGrafanaPanel(a,b){var c=document.createElement("div");c.id="panel-"+a+"-container",c.className="panel-container",document.body.appendChild(c);var d=document.createElement("iframe");d.id="panel-"+a+"-frame",d.className="panel-frame",d.scrolling="no",c.appendChild(d),void 0===b&&(b={}),b.frame=d.id;var e=new GrafanaPanel(b);grafanaPanels.push(e)}var SMARTHOME_GRAFANA_DEFAULTS={debug:"false",sitemap:"default",from:"now-1d",to:"now",theme:"light"},urlParams=queryParams(window.location),parentUrlParams=queryParams(window.parent.location.href),smartHomeSubscriber=new SmartHomeSubscriber,grafanaPanels=[];